{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12 mb-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Importar Notas Fiscais por XML</h5>
                <div>
                    <a href="{{ url_for('importacao_nf.importar') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-cloud-download-alt"></i> API Arquivei
                    </a>
                    <a href="{{ url_for('importacao_nf.index') }}" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left"></i> Voltar
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Você pode importar arquivos de nota fiscal diretamente do seu computador. 
                    Os formatos suportados são <strong>.xml</strong> de NF-e/NFC-e ou arquivos <strong>.zip</strong> contendo múltiplos XMLs.
                </div>
                
                <form method="POST" action="{{ url_for('importacao_nf.importar_xml') }}" enctype="multipart/form-data">
                    <div class="mb-4">
                        <input type="file" name="files[]" multiple accept=".xml,.zip" class="form-control" id="xmlFiles">
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Importar Arquivos
                        </button>
                    </div>
                </form>
                
                <div class="mt-4">
                    <h6 class="border-bottom pb-2 mb-3">Arquivos selecionados</h6>
                    <div id="previewContainer" class="row g-3">
                        <div class="col-12">
                            <p class="text-muted text-center" id="noFilesMsg">
                                Nenhum arquivo selecionado
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <h6 class="border-bottom pb-2 mb-3">Instruções</h6>
                    <ol class="text-muted">
                        <li>Selecione arquivos XML de NF-e/NFC-e ou arquivos ZIP contendo XMLs</li>
                        <li>O sistema irá verificar automaticamente se as notas já existem para evitar duplicidade</li>
                        <li>Para notas já existentes, as informações serão atualizadas</li>
                        <li>O processamento pode demorar alguns minutos dependendo da quantidade de arquivos</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/dropzone/5.9.3/min/dropzone.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    Dropzone.autoDiscover = false;
    
    const previewContainer = document.getElementById('previewContainer');
    const noFilesMsg = document.getElementById('noFilesMsg');
    const btnUpload = document.getElementById('btnUpload');
    
    // Inicializar Dropzone
    const myDropzone = new Dropzone("#xmlDropzone", {
        url: "#", // Será sobrescrito pelo formulário
        autoProcessQueue: false,
        uploadMultiple: true,
        parallelUploads: 10,
        maxFiles: 100,
        acceptedFiles: ".xml,.zip",
        addRemoveLinks: true,
        createImageThumbnails: false,
        dictRemoveFile: "Remover",
        dictCancelUpload: "Cancelar",
        clickable: true,
        previewsContainer: false,
        disablePreviews: true
    });
    
    // Evento quando um arquivo é adicionado
    myDropzone.on("addedfile", file => {
        const fileExtension = file.name.split('.').pop().toLowerCase();
        let iconClass = 'fas fa-file-code text-primary';
        
        if (fileExtension === 'zip') {
            iconClass = 'fas fa-file-archive text-warning';
        }
        
        // Criar item de preview personalizado
        const previewItem = document.createElement('div');
        previewItem.className = 'col-md-4';
        previewItem.dataset.filename = file.name;
        previewItem.innerHTML = `
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <i class="${iconClass} fa-2x"></i>
                        </div>
                        <div class="flex-grow-1 text-truncate">
                            <div class="text-truncate">${file.name}</div>
                            <small class="text-muted">${(file.size / 1024).toFixed(2)} KB</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-danger btn-remove-file">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Adicionar evento para remover arquivo
        previewItem.querySelector('.btn-remove-file').addEventListener('click', function() {
            myDropzone.files.forEach(f => {
                if (f.name === file.name) {
                    myDropzone.removeFile(f);
                }
            });
            previewItem.remove();
            updateFilesUI();
        });
        
        previewContainer.appendChild(previewItem);
        updateFilesUI();
    });
    
    // Evento quando um arquivo é removido
    myDropzone.on("removedfile", file => {
        const item = previewContainer.querySelector(`[data-filename="${file.name}"]`);
        if (item) {
            item.remove();
        }
        updateFilesUI();
    });
    
    // Atualizar UI baseado na quantidade de arquivos
    function updateFilesUI() {
        const fileCount = myDropzone.files.length;
        
        if (fileCount > 0) {
            noFilesMsg.style.display = 'none';
            btnUpload.disabled = false;
            btnUpload.innerHTML = `<i class="fas fa-upload"></i> Importar ${fileCount} arquivo${fileCount > 1 ? 's' : ''}`;
        } else {
            noFilesMsg.style.display = 'block';
            btnUpload.disabled = true;
            btnUpload.innerHTML = '<i class="fas fa-upload"></i> Iniciar Importação';
        }
    }
    
    // Submeter formulário
    document.querySelector('.dropzone-form').addEventListener('submit', function(e) {
        if (myDropzone.files.length === 0) {
            e.preventDefault();
            alert('Selecione pelo menos um arquivo para importar.');
            return false;
        }
        
        // O formulário será enviado normalmente com os arquivos
        return true;
    });
});
</script>
{% endblock %}
